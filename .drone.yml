---
kind: pipeline
name: default

steps:
  - name: copy-sigs
    image: alpine:3
    commands:
      - cp /tmp/signatures.json site/data/signatures/signatures.json
    volumes:
      - name: signatures
        path: /tmp/signatures.json
    when:
      branch:
        - master
      event:
        exclude:
          # do not copy sigs in pull requests to speed up builds
          - pull_request

  - name: hugo
    image: plugins/hugo
    settings:
      source: site
      validate: true

  - name: deploy
    image: docker/compose:1.29.2
    environment:
      XDG_RUNTIME_DIR: "/run/user/1001"
      DOCKER_HOST: "unix:///run/user/1001/docker.sock"
    commands:
      - docker-compose -p pmpc-website up --build -d
    volumes:
      - name: dockersock
        path: /run/user/1001/docker.sock
    when:
      branch:
        - master
      event:
        - push
        - tag
        - deployment
        - cron

# This has to run on the same machine as the forms API until this feature
# exists: https://git.fsfe.org/fsfe-system-hackers/forms/issues/62
node:
  cont2: noris

volumes:
  - name: dockersock
    host:
      path: /run/user/1001/docker.sock
  - name: signatures
    host:
      path: /srv/forms/pmpc/signatures.json
---
kind: signature
hmac: d58a928931a664eb701370b52e57115c7c28fdd82fe62b3251321209252188e4

...
